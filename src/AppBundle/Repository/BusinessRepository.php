<?php

namespace AppBundle\Repository;

use Doctrine\ORM\QueryBuilder;

/**
 * BusinessRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BusinessRepository extends \Doctrine\ORM\EntityRepository {
    public function findByCriteria($criteria){
        $qb = $this->createQueryBuilder('b')
            ->select('b, categories')
            ->join('b.categories', 'categories')
            ->orderBy('b.title', 'ASC')
        ;

        $this->filter($qb, $criteria);

        return $qb;
    }

    private function filter(QueryBuilder $qb, $criteria){
        if(!isset($criteria['terms']) && !$criteria['terms']){
            return $qb;
        }

        $or = $qb->expr()->orX();
        $or->add($qb->expr()->like('b.title', '%:terms%'))
            ->add($qb->expr()->like('b.cep', '%:terms%'));

        $qb->andWhere($or);

        return $qb;
    }

}
